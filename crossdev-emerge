#!/bin/bash

TARGET=$1
shift

PYTHON_PREFIX_DIR=/usr

TARGET_PREFIX_DIR=/usr
TARGET_PYTHON_PREFIX_DIR=usr
TARGET_PKGCONFIG_PREFIX_DIR=usr

CROSS_PREFIX_DIR=/tmp/python-${TARGET}
CROSS_INSTALL_DIR=/tmp/python-${TARGET}

mkdir -p ${CROSS_INSTALL_DIR}
mkdir -p ${CROSS_INSTALL_DIR}/bin
mkdir -p ${CROSS_INSTALL_DIR}/bin/real
mkdir -p ${CROSS_INSTALL_DIR}/lib
mkdir -p ${CROSS_INSTALL_DIR}/lib/pkgconfig
mkdir -p ${CROSS_INSTALL_DIR}/lib64
mkdir -p ${CROSS_INSTALL_DIR}/lib64/pkgconfig

PYTHON_VERS=$(find ${PYTHON_PREFIX_DIR}/bin -regex ".*python[0-9]+.[\.0-9]+[a-z]*$" | sed 's/.*\/python//g' | sort | uniq)

for PYTHON_VER in ${PYTHON_VERS}; do

PYTHON_MAJ=$(echo $1 | cut -d'.' -f1)

PYTHON_REAL=$(readlink -e `which python${PYTHON_VER}`)
PYTHON_CONFIG_REAL=$(readlink -e `which python${PYTHON_VER}-config`)

cat << EOF > ${CROSS_INSTALL_DIR}/bin/python${PYTHON_VER}-config
#!/bin/sh
exec "/usr/${TARGET}/usr/bin/python${PYTHON_VER}-config" "\${@}"
EOF

chmod 750 ${CROSS_INSTALL_DIR}/bin/python${PYTHON_VER}-config
ln -fs ./python${PYTHON_VER}-config ${CROSS_INSTALL_DIR}/bin/python-config
ln -fs ./python${PYTHON_VER}-config ${CROSS_INSTALL_DIR}/bin/python${PYTHON_MAJ}-config
cp -a ${PYTHON_CONFIG_REAL} ${CROSS_INSTALL_DIR}/bin/real/python${PYTHON_VER}-config

for LIB_DIR in lib lib64; do

cat << EOF > ${CROSS_INSTALL_DIR}/${LIB_DIR}/sitecustomize.py
import os
import sys
import site
import distutils.sysconfig

abiflags = ''
if hasattr(sys, 'abiflags'):
  abiflags = sys.abiflags

python_name = 'python' + distutils.sysconfig.get_python_version()
python_name_abi = 'python' + distutils.sysconfig.get_python_version() + abiflags

def get_python_inc(plat_specific=0, prefix=None):
  if prefix:
    return os.path.join(prefix, "include", python_name_abi)
  else:
    return os.path.join('${TARGET_PREFIX_DIR}', '${TARGET}', '${TARGET_PYTHON_PREFIX_DIR}', 'include', python_name_abi)

#def get_python_lib(plat_specific=0, standard_lib=0, prefix=None):
#    if prefix:
#      libpython = os.path.join(prefix, '${LIB_DIR}', python_name)
#    else:
#      libpython = os.path.join('${TARGET_PREFIX_DIR}', '${TARGET}', '${TARGET_PYTHON_PREFIX_DIR}', '${LIB_DIR}', python_name)
#    if standard_lib:
#      return libpython
#    else:
#      return os.path.join(libpython, 'site-packages')

distutils.sysconfig.get_python_inc = get_python_inc
#distutils.sysconfig.get_python_lib = get_python_lib

sys.path, sys_path = sys.path[:1], sys.path[1:]
site.addsitedir(os.path.join('${TARGET_PREFIX_DIR}', '${TARGET}', '${TARGET_PYTHON_PREFIX_DIR}', '${LIB_DIR}', python_name, 'site-packages'))
sys.path.extend(sys_path)

sys.path, sys_path = sys.path[:1], sys.path[1:]
site.addsitedir(os.path.join('${CROSS_PREFIX_DIR}', '${LIB_DIR}', python_name))
sys.path.extend(sys_path)

if '_sysconfigdata' in sys.modules:
  del sys.modules['_sysconfigdata']

if 'sysconfig' in sys.modules:
  del sys.modules['sysconfig']

sys.base_exec_prefix = '${PYTHON_PREFIX_DIR}'
sys.base_prefix = '${PYTHON_PREFIX_DIR}'
sys.exec_prefix = '${PYTHON_PREFIX_DIR}'
sys.prefix = '${PYTHON_PREFIX_DIR}'
EOF

mkdir -p ${CROSS_INSTALL_DIR}/${LIB_DIR}/python${PYTHON_VER}
#mkdir -p ${PYTHON_INSTALL_DIR}/${LIB_DIR}/python${PYTHON_VER}

ln -fs ${TARGET_PREFIX_DIR}/${TARGET}/${TARGET_PKGCONFIG_PREFIX_DIR}/${LIB_DIR}/pkgconfig/python-${PYTHON_VER}.pc ${CROSS_INSTALL_DIR}/${LIB_DIR}/pkgconfig/python.pc
ln -fs ${TARGET_PREFIX_DIR}/${TARGET}/${TARGET_PKGCONFIG_PREFIX_DIR}/${LIB_DIR}/pkgconfig/python-${PYTHON_VER}.pc ${CROSS_INSTALL_DIR}/${LIB_DIR}/pkgconfig/python-${PYTHON_MAJ}.pc
ln -fs ${TARGET_PREFIX_DIR}/${TARGET}/${TARGET_PKGCONFIG_PREFIX_DIR}/${LIB_DIR}/pkgconfig/python-${PYTHON_VER}.pc ${CROSS_INSTALL_DIR}/${LIB_DIR}/pkgconfig/python-${PYTHON_VER}.pc

#rm -f ${CROSS_INSTALL_DIR}/${LIB_DIR}/python${PYTHON_VER}/distutils
#ln -fs ${TARGET_PREFIX_DIR}/${TARGET}/${TARGET_PYTHON_PREFIX_DIR}/${LIB_DIR}/python${PYTHON_VER}/distutils ${CROSS_INSTALL_DIR}/${LIB_DIR}/python${PYTHON_VER}/distutils
ln -fs ${TARGET_PREFIX_DIR}/${TARGET}/${TARGET_PYTHON_PREFIX_DIR}/${LIB_DIR}/python${PYTHON_VER}/sysconfig.py ${CROSS_INSTALL_DIR}/${LIB_DIR}/python${PYTHON_VER}/sysconfig.py

if [[ -d "${TARGET_PREFIX_DIR}/${TARGET}/${TARGET_PYTHON_PREFIX_DIR}/${LIB_DIR}/python${PYTHON_VER}/" ]]; then
  if [[ ! -z "$(find ${TARGET_PREFIX_DIR}/${TARGET}/${TARGET_PYTHON_PREFIX_DIR}/${LIB_DIR}/python${PYTHON_VER}/ -name "_sysconfigdata*.py" | head -n 1)" ]]; then
    #ln -fs $(find ${TARGET_PREFIX_DIR}/${TARGET}/${TARGET_PYTHON_PREFIX_DIR}/${LIB_DIR}/python${PYTHON_VER}/ -name "_sysconfigdata*.py" | head -n 1) ${PYTHON_INSTALL_DIR}/${LIB_DIR}/python${PYTHON_VER}/_sysconfigdata.py
    ln -fs $(find ${TARGET_PREFIX_DIR}/${TARGET}/${TARGET_PYTHON_PREFIX_DIR}/${LIB_DIR}/python${PYTHON_VER}/ -name "_sysconfigdata*.py" | head -n 1) ${CROSS_INSTALL_DIR}/${LIB_DIR}/python${PYTHON_VER}/_sysconfigdata.py
  fi
fi

done

done

export PYTHONPATH="/tmp/python-${TARGET}/lib"
export PATH="/tmp/python-${TARGET}/bin:${PATH}"
export _PYTHON_SYSCONFIGDATA_NAME=_sysconfigdata

#python2 -c 'import inspect; import sysconfig; import _sysconfigdata; import distutils.sysconfig; print(distutils.sysconfig.get_python_inc()); print(inspect.getfile(_sysconfigdata)); print(inspect.getfile(sysconfig));'
#python3 -c 'import inspect; import sysconfig; import _sysconfigdata; import distutils.sysconfig; print(distutils.sysconfig.get_python_inc()); print(inspect.getfile(_sysconfigdata)); print(inspect.getfile(sysconfig));'

FEATURES="-sandbox -usersandbox -userpriv" ROOT="/usr/${TARGET}/" PORTAGE_CONFIGROOT="/usr/${TARGET}/" ${TARGET}-emerge --config-root="/usr/${TARGET}/" $@
