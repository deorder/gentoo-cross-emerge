#!/bin/bash

CD_CUR_DIR=$(dirname "${BASH_SOURCE[0]}")

source "${CD_CUR_DIR}/crossdev-functions.sh"

cd_parse_arguments $@

if [[ ! -z "${CD_HELP}" ]]; then
  cd_print_usage_header
  exit 1
fi

CD_COW_PREFIX_DIR=${CD_TMP_DIR}/cow-${CD_TARGET}
CD_UNION_PREFIX_DIR=${CD_TMP_DIR}/union-${CD_TARGET}

mkdir -p "${CD_COW_PREFIX_DIR}"
mkdir -p "${CD_UNION_PREFIX_DIR}"

if [[ -f "${CD_CONFIG_DIR}/crossdev-cow-env-init-pre" ]]; then
  ebegin "Executing crossdev cow env init pre hook"
  source "${CD_CONFIG_DIR}/crossdev-cow-env-init-pre" || cd_die
  eend 0
fi

ebegin "Initializing environment"

ebegin "Mounting union"
unionfs -o cow "${CD_COW_PREFIX_DIR}"=RW:/=RO "${CD_UNION_PREFIX_DIR}" || cd_die
eend 0

eend 0

if [[ -f "${CD_CONFIG_DIR}/crossdev-cow-env-init-post" ]]; then
  ebegin "Executing crossdev cow env init post hook"
  source "${CD_CONFIG_DIR}/crossdev-cow-env-init-post" || cd_die
  eend 0
fi
